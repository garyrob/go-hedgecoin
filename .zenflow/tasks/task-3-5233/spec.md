# Task 3 — Extend Membership Struct and Config

## Technical Specification

### Difficulty Assessment: **Easy**

This task involves straightforward structural changes to existing Go types with no complex logic. While the implementation is simple, **careful verification is critical** — missing Membership construction sites could cause subtle runtime failures in future tasks that depend on the new fields being populated.

---

## Technical Context

- **Language**: Go 1.21+
- **Dependencies**: No new external dependencies
- **Related Tasks**: Task 1 (Core Types & Interfaces) - Already complete

---

## Implementation Approach

### 1. Modify Membership Struct

**File**: `data/committee/committee.go`

Add two new fields to the `Membership` struct:

```go
type Membership struct {
    Record              BalanceRecord
    Selector            Selector
    TotalMoney          basics.MicroAlgos
    ExternalWeight      uint64  // NEW: Individual account's external consensus weight
    TotalExternalWeight uint64  // NEW: Total network external consensus weight
}
```

The new fields default to zero values (Go's default for `uint64`), which is the correct behavior for sites that don't need to populate them yet.

### 2. Update Config Package

**File**: `config/localTemplate.go`

Add a new field for the external weight oracle port:

```go
// ExternalWeightOraclePort specifies the TCP port for connecting to the external weight daemon.
// A value of 0 means no external weight daemon is configured, which will cause startup
// failure if the node attempts to use external weights for consensus.
ExternalWeightOraclePort uint16 `version[39]:"0"`
```

Also update the Version field to include version 39:
```go
Version uint32 `version[0]:"0" ... version[38]:"38" version[39]:"39"`
```

**File**: `config/local_defaults.go`

After running `make generate`, this will automatically update to:
```go
Version: 39,
ExternalWeightOraclePort: 0,
```

### 3. Update Test Config Fixtures

**New file**: `test/testdata/configs/config-v39.json`

This file will be auto-generated by `make generate`, containing all default config values with Version: 39.

---

## Source Code Structure Changes

### Files to Modify

| File | Change Type | Description |
|------|-------------|-------------|
| `data/committee/committee.go:50-54` | Modify | Add `ExternalWeight` and `TotalExternalWeight` fields to `Membership` struct |
| `config/localTemplate.go:46` | Modify | Update Version field tag to include `version[39]:"39"` |
| `config/localTemplate.go` (before closing brace, ~line 669) | Add | New `ExternalWeightOraclePort uint16` field with `version[39]:"0"` |
| `data/committee/credential_test.go` | **No changes required** | All 11 `Membership{}` literals use named field initialization, so Go automatically zero-initializes the new fields |

### Files Auto-Generated

| File | Description |
|------|-------------|
| `config/local_defaults.go` | Auto-updated by `make generate` |
| `test/testdata/configs/config-v39.json` | Auto-created by `make generate` |

---

## Data Model Changes

### Membership Struct

**Before**:
```go
type Membership struct {
    Record     BalanceRecord
    Selector   Selector
    TotalMoney basics.MicroAlgos
}
```

**After**:
```go
type Membership struct {
    Record              BalanceRecord
    Selector            Selector
    TotalMoney          basics.MicroAlgos
    ExternalWeight      uint64
    TotalExternalWeight uint64
}
```

### Config Local Struct

**Addition**:
```go
// ExternalWeightOraclePort specifies the TCP port for connecting to the external weight daemon.
// A value of 0 means no external weight daemon is configured, which will cause startup
// failure if the node attempts to use external weights for consensus.
ExternalWeightOraclePort uint16 `version[39]:"0"`
```

---

## API / Interface Changes

No interface changes. The `Membership` struct is used internally and is not part of any public API.

---

## Codebase Audit: Membership Construction Sites

Before completing this task, all `Membership{}` literal constructions must be identified and updated.

**Search commands**:
```bash
grep -rn 'committee\.Membership{' .
grep -rn 'Membership{' data/committee/ agreement/
```

**Known construction sites** (from codebase search):

1. `data/committee/credential_test.go:53` - Test code
2. `data/committee/credential_test.go:77` - Test code
3. `data/committee/credential_test.go:117` - Test code
4. `data/committee/credential_test.go:137` - Test code
5. `data/committee/credential_test.go:178` - Test code
6. `data/committee/credential_test.go:228` - Test code
7. `data/committee/credential_test.go:269` - Test code
8. `data/committee/credential_test.go:303` - Test code
9. `data/committee/credential_test.go:335` - Test code
10. `data/committee/credential_test.go:363` - Test code
11. `data/committee/credential_test.go:406` - Test code
12. `agreement/selector.go:94-96` - Production code (uses field assignment, not struct literal)

The `agreement/selector.go:68` `membership()` function populates `Membership` fields individually (lines 94-96), so it does not require immediate changes — it will need to be updated in Task 5.

**Important**: All test constructions in `credential_test.go` use named field initialization (e.g., `Membership{Record: record, Selector: sel, TotalMoney: totalMoney}`). Go automatically zero-initializes unspecified fields, so **no modifications to the test file are required** — the code will compile and run correctly as-is. The tests don't exercise weight-based paths, so zero values are appropriate.

---

## Verification Approach

### 1. Compilation Test
```bash
make build
```
All current `Membership{}` construction sites use named field initialization, so Go automatically zero-initializes the new fields. The build will succeed without modifying those sites. However, if any site used positional initialization (which none do), Go would report a compilation error here.

### 2. Unit Tests
```bash
go test -v ./data/committee/...
go test -v ./config/...
```

### 3. Config Tests
The config package tests verify:
- Round-trip serialization/deserialization
- Version migration works correctly
- Default values are correct

### 4. Full Test Suite
```bash
make test
```

### 5. Code Generation Verification
```bash
make generate
git diff  # Should show expected changes in local_defaults.go and config-v39.json
```

---

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Missed Membership construction sites | Comprehensive grep search confirms all sites use named fields (auto zero-init) |
| Config migration issues | Existing config tests validate migration paths |
| msgp serialization | `Membership` struct does not have msgp tags; no regeneration needed |

---

## Post-Modification Checklist

1. [ ] Add `ExternalWeight` and `TotalExternalWeight` to `Membership` struct
2. [ ] Update `config/localTemplate.go` Version field to include `version[39]:"39"`
3. [ ] Add `ExternalWeightOraclePort uint16` with `version[39]:"0"` to `config/localTemplate.go` (before the struct's closing brace)
4. [ ] Run `make generate` to update auto-generated files
5. [ ] Run `make sanity` to verify code quality
6. [ ] Run `make test` to verify all tests pass
7. [ ] Verify `config-v39.json` was created with correct values
8. [ ] Verify `credential_test.go` compiles without changes (named field init handles new fields)
